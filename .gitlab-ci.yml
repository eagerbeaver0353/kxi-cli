---
default:
  tags:
    - k8s-gcp-tools
  interruptible: true

include:
  - project: 'kxdev/shared-tools/ci-templates'
    ref: main
    file:
      - 'insights/whitesource.yaml'
      - 'insights/test.yaml'

stages:
  - build
  - test
  - sonarqube
  - publish
  - docs

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
  key: "$CI_JOB_NAME"

.default-rules:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_MERGE_REQUEST_IID

build dist:
  stage: build
  image: python:3
  rules:
    - !reference [ .default-rules, rules ]
  script:
    - python3 -m pip install --upgrade build
    - python3 -m build
  artifacts:
    paths:
      - dist

.run-tests:
  stage: test
  image: python:3
  rules:
    - !reference [ .default-rules, rules ]
  script:
    - pip install -r kxicli/tests/requirements.txt
    - pip install dist/*.whl
    - export KUBECONFIG=$(pwd)/kxicli/tests/files/test-kube-config
    - coverage run -m pytest
    - coverage report
    - coverage html
    - coverage xml
  artifacts:
    paths:
      - htmlcov
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

whitesource-dep-scan:
  stage: test
  extends:
    - .whitesource-scan
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    KUBERNETES_MEMORY_REQUEST: "600Mi"
    KUBERNETES_MEMORY_LIMIT: "1Gi"
    WS_PRODUCTNAME: "insights"
    WS_PRODUCTVERSION: "main"
    WS_PROJECTNAME: "$CI_PROJECT_NAME"
    WS_PROJECTVERSION: "$CI_DEFAULT_BRANCH"

run tests 3.6:
  extends: .run-tests
  image: python:3.6

run tests 3.7:
  extends: .run-tests
  image: python:3.7

run tests 3.8:
  extends: .run-tests
  image: python:3.8

run tests 3.9:
  extends: .run-tests
  image: python:3.9

run tests 3.10:
  extends: .run-tests
  image: python:3.10

publish package:
  stage: publish
  image: python:3
  variables:
    PYPI_URL: "https://nexus.internal-insights.kx.com/repository/kxi/"
    TWINE_USERNAME: "$INT_NEXUS_USER_RW"
    TWINE_PASSWORD: "$INT_NEXUS_PASS_RW"
  script:
    - python -m pip install --upgrade twine
    - python -m twine upload  --non-interactive --repository-url  "$PYPI_URL" dist/*.whl
  rules:
    - if: $CI_COMMIT_TAG

publish package external kxi-pypi-public:
  stage: publish
  image: python:3
  variables:
    PYPI_URL: "https://nexus.dl.kx.com/repository/kxi-pypi-public/"
    TWINE_USERNAME: "$EXT_NEXUS_USER_RW"
    TWINE_PASSWORD: "$EXT_NEXUS_PASS_RW"
  script:
    - python -m pip install --upgrade twine
    - python -m twine upload  --non-interactive --repository-url  "$PYPI_URL" dist/*.whl
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

pages:
  image: python:3.8
  stage: docs
  script:
    - pip install -r mkdocs.requirements
    - pip install .
    - mkdocs build --strict
    - mv site public/
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "$CI_DEFAULT_BRANCH"'
      when: always
    - when: never

sonarqube-check:
  stage: sonarqube
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  needs:
    - run tests 3.8
  allow_failure: true
  rules:
    - !reference [ .default-rules, rules ]

spell-check:
  stage: test
  extends:
    - .cspell
  rules:
    - !reference [ .default-rules, rules ]
  script:
    - cspell "kxicli/**/*.py"
