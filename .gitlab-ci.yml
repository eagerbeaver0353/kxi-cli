---
default:
  tags:
    - k8s-gcp-tools
  interruptible: true

include:
  - project: 'kxdev/shared-tools/ci-templates'
    ref: main
    file:
      - 'insights/whitesource.yaml'
      - 'insights/test.yaml'
      - 'security/security.yaml'

stages:
  - build
  - test
  - sonarqube
  - publish
  - docs

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  KX_PIP_EXTRA_INSTALL_URL: "https://${INT_NEXUS_USER_RW}:${INT_NEXUS_PASS_RW}@${INSIGHTS_DEV_NEXUS_URL_NOPREFIX}/repository/kxi/simple"

cache:
  paths:
    - .cache/pip
  key: "$CI_JOB_NAME"

.default-rules:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_MERGE_REQUEST_IID

build dist:
  stage: build
  image: python:3
  rules:
    - !reference [ .default-rules, rules ]
  before_script:
    - python3 -m pip config set install.extra-index-url "${KX_PIP_EXTRA_INSTALL_URL}"
    - python3 -m pip install --upgrade build
  script:
    - SETUPTOOLS_SCM_DEBUG=1 python3 -m build
  artifacts:
    paths:
      - dist

.run-tests:
  stage: test
  image: python:3
  rules:
    - !reference [ .default-rules, rules ]
  before_script:
    - python3 -m pip config set install.extra-index-url "${KX_PIP_EXTRA_INSTALL_URL}"
    - pip install .[dev]
    - pip install dist/*.whl
  script:
    - export KUBECONFIG=$(pwd)/tests/files/test-kube-config
    - coverage run -m pytest --junitxml=report.xml
    - coverage report
    - coverage html
    - coverage xml
  coverage: /^TOTAL.*\s+(\d+%)$/
  artifacts:
    paths:
      - htmlcov
      - coverage.xml
      - report.xml
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

whitesource-dep-scan:
  stage: test
  extends:
    - .whitesource-scan
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    KUBERNETES_MEMORY_REQUEST: "600Mi"
    KUBERNETES_MEMORY_LIMIT: "1Gi"
    WS_PRODUCTNAME: "insights"
    WS_PRODUCTVERSION: "main"
    WS_PROJECTNAME: "$CI_PROJECT_NAME"
    WS_PROJECTVERSION: "$CI_DEFAULT_BRANCH"

whitesource-release-dep-scan:
  stage: test
  extends:
    - .whitesource-scan
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /release\/.*/
  before_script:
      - |
        export WS_PRODUCTVERSION="${CI_COMMIT_REF_NAME#*/}"
        export WS_PROJECTVERSION="${CI_COMMIT_REF_NAME#*/}"
  variables:
    WS_PRODUCTNAME: "insights"
    WS_PROJECTNAME: "$CI_PROJECT_NAME"
    KUBERNETES_MEMORY_REQUEST: "600Mi"
    KUBERNETES_MEMORY_LIMIT: "1Gi"

run tests 3.7:
  extends: .run-tests
  image: python:3.7

run tests 3.8:
  extends: .run-tests
  image: python:3.8

run tests 3.9:
  extends: .run-tests
  image: python:3.9

run tests 3.10:
  extends: .run-tests
  image: python:3.10

publish package:
  stage: publish
  image: python:3
  variables:
    PYPI_URL: "$INSIGHTS_DEV_NEXUS_URL"
    TWINE_USERNAME: "$INT_NEXUS_USER_RW"
    TWINE_PASSWORD: "$INT_NEXUS_PASS_RW"
  before_script:
    - python -m pip install --upgrade twine
  script:
    - python -m twine upload  --non-interactive --repository-url "${PYPI_URL}/repository/kxi/" dist/*.whl
  rules:
    - if: $CI_COMMIT_TAG

publish package external kxi-pypi-public:
  stage: publish
  image: python:3
  variables:
    PYPI_URL: "$INSIGHTS_PROD_NEXUS_URL"
    TWINE_USERNAME: "$EXT_NEXUS_USER_RW"
    TWINE_PASSWORD: "$EXT_NEXUS_PASS_RW"
  before_script:
    - python -m pip install --upgrade twine
  script:
    - python -m twine upload  --non-interactive --repository-url "${PYPI_URL}/repository/kxi-pypi-public/" dist/*.whl
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

pages:merge-request:
  image: python:3.8
  stage: docs
  variables:
    PREVIEW_ROOT: "https://kxdev.gitlab.io/-/kxinsights/kxi-cli"
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: "$PREVIEW_ROOT/-/jobs/$CI_JOB_ID/artifacts/public/cli/index.html"
    auto_stop_in: 3 days
  before_script:
    - python3 -m pip config set install.extra-index-url "${KX_PIP_EXTRA_INSTALL_URL}"
    - pip install .[doc]
  script:
    - mkdocs build --strict
    - mv site public/
  artifacts:
    paths:
      - public
  rules:
    # Run job on Merge Request
    - if: $CI_MERGE_REQUEST_ID

pages:
  image: python:3.8
  stage: docs
  variables:
    PREVIEW_ROOT: "https://kxdev.gitlab.io/-/kxinsights/kxi-cli"
  environment:
    name: main
    url: "$PREVIEW_ROOT/-/jobs/$CI_JOB_ID/artifacts/public/cli/index.html"
  before_script:
    - python3 -m pip config set install.extra-index-url "${KX_PIP_EXTRA_INSTALL_URL}"
    - pip install .[doc]
  script:
    - mkdocs build --strict
    - mv site public/
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

sonarqube-check:
  stage: sonarqube
  extends: .sonar-template
  needs:
    - run tests 3.8
  rules:
    - !reference [ .default-rules, rules ]

spell-check:
  stage: test
  extends:
    - .cspell
  rules:
    - !reference [ .default-rules, rules ]
  script:
    - cspell "kxicli/**/*.py"
